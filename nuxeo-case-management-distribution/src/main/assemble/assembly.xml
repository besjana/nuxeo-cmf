<project name="nuxeo-assembly" default="build" xmlns:nx="urn:nuxeo-build"
  xmlns:artifact="urn:nuxeo-artifact">

  <taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build" />
  <taskdef resource="org/nuxeo/build/artifact/antlib.xml"
    uri="urn:nuxeo-artifact" />

  <filterset id="filter-resources">
    <filter token="nuxeo.core.version" value="${nuxeo.core.version}" />
  </filterset>

  <target name="init" unless="init.done">
    <condition property="build.ear">
      <isset property="maven.profile.cm-dev" />
    </condition>
    <condition property="build.server">
      <isset property="maven.profile.server" />
    </condition>

    <property name="outdir" value="${maven.project.build.directory}" />
    <property name="stagedir" value="${outdir}/stage" />
    <property name="finaltarget" value="../target" />


    <antcall target="expand" />
    <property name="init.done" value="true" />

  </target>

  <target name="build">
    <antcall target="cleanoutput" />
    <antcall target="server" />
  </target>

  <target name="expand" unless="no.build">
    <artifact:expand depth="3" />
  </target>

  <target name="cleanoutput">
    <delete dir="${finaltarget}" />
  </target>

  <target name="server" depends="init" description="Server packaging" if="build.server">
    <echo>nuxeo-cm-distribution server build (JBoss)...</echo>
    <mkdir dir="${stagedir}" />
    <unzip dest="${stagedir}">
      <artifact:resolveFile key="org.nuxeo.ecm.distribution:nuxeo-distribution-jboss:${nuxeo.platform.version}:zip"
                            classifier="nuxeo-dm" />
      <patternset>
        <exclude name="**/templates/common-sfsl/**" />
        <exclude name="**/templates/stateful/**" />
        <exclude name="**/templates/stateless/**" />
      </patternset>
    </unzip>
    <property name="app.path" value="${stagedir}/nuxeo-cm-server" />
    <nx:rename from="${stagedir}/nuxeo-*" to="${app.path}" />
    <chmod dir="${app.path}" perm="750" includes="*.sh,bin/*.sh" />
    <!-- remove open social -->
    <delete failonerror="false" verbose="true">
      <fileset 
	 dir="${app.path}/server/default/deploy/nuxeo.ear/system"
	 includes="nuxeo-opensocial-*"/> 
      <fileset
         dir="${app.path}/server/default/deploy/nuxeo.ear/system"
         includes="nuxeo-spaces-*"/>
      <fileset
         dir="${app.path}/server/default/deploy/nuxeo.ear/system"
         includes="nuxeo-webengine-gadgets-*"/>
      <fileset 
	 dir="${app.path}/templates/common/config"
	 includes="opensocial.properties default-opensocial-config.xml" />
    </delete>
    <!-- Deploy Custom plugins -->
    <copy todir="${app.path}/server/default/deploy/nuxeo.ear/plugins">
      <artifact:set groupId="org.nuxeo.cm" type="jar" />
      <artifact:set groupId="org.nuxeo.ecm.platform" artifactId="nuxeo-classification-*"/>
      <artifact:set groupId="org.nuxeo.ecm.platform" artifactId="nuxeo-platform-importer-core"/>
    </copy>
    <!-- Deploy custom configuration -->
    <copy todir="${app.path}/templates/" overwrite="true">
      <fileset dir="src/main/resources" />
    </copy>
    <echo file="${app.path}/templates/common/nuxeo.defaults" append="yes" message="nuxeo.template.includes=common-deploydir,cmf" /> 
    <antcall target="zip">
      <param name="distribution" value="server" />
    </antcall>
  </target>

  <target name="zip">
    <zip
       destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}-${distribution}.zip"
       basedir="${stagedir}" />
    <echo>Distribution built:
      ${outdir}/${maven.project.artifactId}-${maven.project.version}-${distribution}.zip</echo>
    <artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}-${distribution}.zip" classifier="${distribution}" type="zip" target="${maven.project.groupId}:${maven.project.artifactId}" />
  </target>

</project>
